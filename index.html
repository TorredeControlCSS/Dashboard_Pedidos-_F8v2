<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Gestión de Pedidos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --success-color: #2ecc71;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #333;
        }
        
        .dashboard-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1.5rem 0;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: transform 0.3s, box-shadow 0.3s;
            margin-bottom: 1.5rem;
            height: 100%;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }
        
        .card-header {
            background-color: var(--primary-color);
            color: white;
            border-radius: 10px 10px 0 0 !important;
            font-weight: 600;
        }
        
        .metric-card {
            text-align: center;
            padding: 1.5rem;
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            margin: 0.5rem 0;
        }
        
        .metric-label {
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        .progress {
            height: 10px;
            margin-top: 10px;
        }
        
        .status-badge {
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-completed {
            background-color: #d1edff;
            color: #0c5460;
        }
        
        .status-delayed {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .status-in-process {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        
        .filter-section {
            background-color: white;
            padding: 1rem;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 1.5rem;
        }
        
        .data-table {
            font-size: 0.85rem;
        }
        
        .data-table th {
            background-color: var(--light-color);
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }
        
        .last-update {
            font-size: 0.8rem;
            color: #6c757d;
            text-align: right;
        }
        
        .table-container {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .action-btn {
            margin: 0 2px;
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }
        
        .debug-info {
            font-size: 0.7rem;
            color: #6c757d;
            background-color: #f8f9fa;
            padding: 0.5rem;
            border-radius: 5px;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="fas fa-tachometer-alt me-2"></i>Dashboard de Gestión de Pedidos</h1>
                    <p class="mb-0">Seguimiento y análisis de pedidos en tiempo real</p>
                </div>
                <div class="col-md-4 text-end">
                    <button id="refresh-btn" class="btn btn-light">
                        <i class="fas fa-sync-alt"></i> Actualizar Datos
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Filtros -->
        <div class="filter-section">
            <div class="row">
                <div class="col-md-2">
                    <label for="date-range" class="form-label">Rango de Fechas</label>
                    <select class="form-select" id="date-range">
                        <option value="7">Últimos 7 días</option>
                        <option value="30" selected>Últimos 30 días</option>
                        <option value="90">Últimos 3 meses</option>
                        <option value="365">Último año</option>
                        <option value="all">Todos</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="status-filter" class="form-label">Estado</label>
                    <select class="form-select" id="status-filter">
                        <option value="all" selected>Todos los estados</option>
                        <option value="Pendiente">Pendiente</option>
                        <option value="En Proceso">En Proceso</option>
                        <option value="Completado">Completado</option>
                        <option value="Retrasado">Retrasado</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="division-filter" class="form-label">División</label>
                    <select class="form-select" id="division-filter">
                        <option value="all" selected>Todas las divisiones</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="executor-filter" class="form-label">Unidad Ejecutora</label>
                    <select class="form-select" id="executor-filter">
                        <option value="all" selected>Todas las unidades</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="order-type-filter" class="form-label">Tipo de Pedido</label>
                    <select class="form-select" id="order-type-filter">
                        <option value="all" selected>Todos los tipos</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="search" class="form-label">Buscar</label>
                    <input type="text" class="form-control" id="search" placeholder="Buscar pedido...">
                </div>
            </div>
            <div class="debug-info">
                <span id="data-info">Esperando datos...</span>
            </div>
        </div>

        <!-- Métricas principales -->
        <div class="row">
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="metric-label">Total de Pedidos</div>
                        <div class="metric-value" id="total-orders">--</div>
                        <div class="text-success">
                            <small><i class="fas fa-arrow-up"></i> <span id="growth-rate">--</span>% vs período anterior</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="metric-label">Pedidos Pendientes</div>
                        <div class="metric-value" id="pending-orders">--</div>
                        <div class="progress">
                            <div class="progress-bar bg-warning" role="progressbar" id="pending-progress" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="metric-label">Cantidad Total Asignada</div>
                        <div class="metric-value" id="total-assigned">--</div>
                        <div class="metric-label">unidades</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="metric-label">Tasa de Completitud</div>
                        <div class="metric-value" id="completion-rate">--</div>
                        <div class="progress">
                            <div class="progress-bar bg-success" role="progressbar" id="completion-progress" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gráficos y tabla -->
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        Evolución de Pedidos por Fecha
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="orders-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        Distribución por Estado
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="status-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla de pedidos -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Lista Detallada de Pedidos</span>
                <span class="last-update" id="last-update">Última actualización: --</span>
            </div>
            <div class="card-body p-0">
                <div class="table-container">
                    <table class="table table-hover data-table table-striped mb-0">
                        <thead>
                            <tr>
                                <th>ID Pedido</th>
                                <th>Expedido a CSW</th>
                                <th>Unidad Ejecutora</th>
                                <th>Tipo de Pedido</th>
                                <th>División</th>
                                <th>Grupo</th>
                                <th>Tipo Sustancias</th>
                                <th>Cant. Total Asignada</th>
                                <th>Cant. Total Solicitada</th>
                                <th>Rm. Asignados</th>
                                <th>Fecha Recepción F8</th>
                                <th>Fecha Salida</th>
                                <th>Fecha Disponición</th>
                                <th>Fecha Facturación</th>
                                <th>Fecha Empacado</th>
                                <th>Fecha Entrega Real</th>
                                <th>Tiempo Estable</th>
                                <th>% Procesamiento</th>
                                <th>Coeficiente Anexo: U1</th>
                                <th>Coeficiente V/L</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table-body">
                            <tr>
                                <td colspan="22" class="text-center">
                                    <div class="loading-spinner">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Cargando datos...</span>
                                        </div>
                                        <span class="ms-2">Conectando con Google Sheets...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // URL de Google Sheets
        const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSC_myZfLrWVb3rzsFbX_7w9nuR2zBJxEYUqMh5UcSb07hwee7_7UECeU2zTFRePSgUwpvE0IcRmTmJ/pub?gid=323536618&single=true&output=csv';
        
        // Variables globales
        let ordersData = [];
        let ordersChart, statusChart;
        
        // Inicializar dashboard
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Iniciando dashboard...');
            loadData();
            
            // Configurar eventos
            document.getElementById('refresh-btn').addEventListener('click', loadData);
            document.getElementById('date-range').addEventListener('change', updateDashboard);
            document.getElementById('status-filter').addEventListener('change', updateDashboard);
            document.getElementById('division-filter').addEventListener('change', updateDashboard);
            document.getElementById('executor-filter').addEventListener('change', updateDashboard);
            document.getElementById('order-type-filter').addEventListener('change', updateDashboard);
            document.getElementById('search').addEventListener('input', updateDashboard);
        });
        
        // Cargar datos desde Google Sheets
        async function loadData() {
            try {
                showLoadingState();
                updateDataInfo('Conectando con Google Sheets...');
                
                console.log('Cargando datos desde:', SHEET_URL);
                
                // Usar fetch directamente (sin proxy para evitar problemas)
                const response = await fetch(SHEET_URL);
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status} - ${response.statusText}`);
                }
                
                const csvText = await response.text();
                console.log('Datos CSV recibidos:', csvText.substring(0, 500) + '...');
                
                if (!csvText || csvText.trim().length === 0) {
                    throw new Error('El archivo CSV está vacío');
                }
                
                // Procesar los datos
                ordersData = parseCSV(csvText);
                console.log('Datos parseados. Número de registros:', ordersData.length);
                
                if (ordersData.length === 0) {
                    // Si no hay datos, crear datos de ejemplo para demostración
                    createSampleData();
                    updateDataInfo('Usando datos de ejemplo (no se encontraron datos reales)');
                } else {
                    updateDataInfo(`Cargados ${ordersData.length} pedidos correctamente`);
                }
                
                updateLastUpdateTime();
                populateFilters();
                updateDashboard();
                
            } catch (error) {
                console.error('Error al cargar los datos:', error);
                
                // En caso de error, crear datos de ejemplo
                createSampleData();
                updateDataInfo('Error al cargar datos reales. Usando datos de ejemplo: ' + error.message);
                updateLastUpdateTime();
                populateFilters();
                updateDashboard();
            }
        }
        
        // Crear datos de ejemplo para demostración
        function createSampleData() {
            ordersData = [];
            const divisions = ['SALMI', 'FARMACIA', 'LABORATORIO', 'QUIRÓFANO'];
            const executors = ['CSW Central', 'CSW Norte', 'CSW Sur', 'CSW Este'];
            const orderTypes = ['Urgente', 'Programado', 'Rutina'];
            const substances = ['Medicamentos', 'Materiales', 'Equipos', 'Reactivos'];
            const statuses = ['Pendiente', 'En Proceso', 'Completado', 'Retrasado'];
            
            for (let i = 1; i <= 50; i++) {
                const order = {
                    'ID Pedido': `PED${i.toString().padStart(4, '0')}`,
                    'Expedido a CSW': executors[Math.floor(Math.random() * executors.length)],
                    'Unidad Ejecutora': executors[Math.floor(Math.random() * executors.length)],
                    'Tipo de Pedido': orderTypes[Math.floor(Math.random() * orderTypes.length)],
                    'División': divisions[Math.floor(Math.random() * divisions.length)],
                    'Grupo': `GRP${Math.floor(Math.random() * 5) + 1}`,
                    'Tipo Sustancias': substances[Math.floor(Math.random() * substances.length)],
                    'Cantidad Total Asignada': Math.floor(Math.random() * 1000) + 100,
                    'Cantidad Total Solicitada': Math.floor(Math.random() * 1200) + 100,
                    'Rm. Asignados': Math.floor(Math.random() * 50) + 5,
                    'Fecha Recepción F8': randomDate(new Date(2024, 0, 1), new Date()),
                    'Fecha Salida': Math.random() > 0.3 ? randomDate(new Date(2024, 0, 1), new Date()) : '',
                    'Fecha Disponición': Math.random() > 0.4 ? randomDate(new Date(2024, 0, 1), new Date()) : '',
                    'Fecha Facturación': Math.random() > 0.5 ? randomDate(new Date(2024, 0, 1), new Date()) : '',
                    'Fecha Empacado': Math.random() > 0.6 ? randomDate(new Date(2024, 0, 1), new Date()) : '',
                    'Fecha Entrega Real': Math.random() > 0.7 ? randomDate(new Date(2024, 0, 1), new Date()) : '',
                    'Tiempo Estable': Math.floor(Math.random() * 10) + 1,
                    '% Procesamiento': Math.floor(Math.random() * 100),
                    'Coeficiente Anexo: U1': (Math.random() * 2).toFixed(2),
                    'Coeficiente V/L': (Math.random() * 1.5).toFixed(2),
                    'Estado': statuses[Math.floor(Math.random() * statuses.length)]
                };
                ordersData.push(order);
            }
            
            console.log('Datos de ejemplo creados:', ordersData.length, 'registros');
        }
        
        // Función para generar fechas aleatorias
        function randomDate(start, end) {
            const date = new Date(start.getTime() + Math.random() * (end.getTime() - start.getTime()));
            return date.toISOString().split('T')[0]; // Formato YYYY-MM-DD
        }
        
        // Parsear CSV a JSON
        function parseCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim() !== '');
            if (lines.length === 0) return [];
            
            console.log('Número de líneas en CSV:', lines.length);
            console.log('Primera línea (encabezados):', lines[0]);
            
            // Detectar delimitador
            const firstLine = lines[0];
            let delimiter = ',';
            if (firstLine.includes(';') && firstLine.split(';').length > firstLine.split(',').length) {
                delimiter = ';';
            }
            
            console.log('Delimitador detectado:', delimiter);
            
            const headers = firstLine.split(delimiter).map(header => 
                header.trim().replace(/^"|"$/g, '')
            );
            
            console.log('Encabezados detectados:', headers);
            
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue;
                
                const values = parseCSVLine(lines[i], delimiter);
                const entry = {};
                
                headers.forEach((header, index) => {
                    let value = values[index] ? values[index].trim().replace(/^"|"$/g, '') : '';
                    
                    // Convertir a número si es posible
                    if (!isNaN(value) && value !== '' && value.trim() !== '') {
                        value = Number(value);
                    }
                    
                    entry[header] = value;
                });
                
                // Asignar un ID si no existe
                if (!entry.ID && !entry['ID Pedido']) {
                    entry.ID = `P${i.toString().padStart(4, '0')}`;
                }
                
                // Determinar estado si no existe
                if (!entry.Estado) {
                    entry.Estado = determineStatus(entry);
                }
                
                data.push(entry);
            }
            
            console.log('Primeros registros parseados:', data.slice(0, 3));
            return data;
        }
        
        // Función para parsear líneas CSV correctamente
        function parseCSVLine(line, delimiter) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];
                
                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        current += '"';
                        i++; // Saltar la siguiente comilla
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === delimiter && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result;
        }
        
        // Poblar todos los filtros
        function populateFilters() {
            populateFilter('division-filter', 'División');
            populateFilter('executor-filter', 'Unidad Ejecutora');
            populateFilter('order-type-filter', 'Tipo de Pedido');
        }
        
        // Poblar un filtro específico
        function populateFilter(filterId, fieldName) {
            const filter = document.getElementById(filterId);
            
            // Obtener valores únicos de los datos
            const values = [...new Set(ordersData.map(order => 
                order[fieldName] || 'Sin especificar'
            ))].filter(value => value !== '' && value !== 'Sin especificar');
            
            // Limpiar opciones existentes (excepto "Todas")
            while (filter.children.length > 1) {
                filter.removeChild(filter.lastChild);
            }
            
            // Agregar opciones
            values.forEach(value => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = value;
                filter.appendChild(option);
            });
        }
        
        // Actualizar dashboard con datos filtrados
        function updateDashboard() {
            const filteredData = filterData();
            updateMetrics(filteredData);
            updateCharts(filteredData);
            updateTable(filteredData);
        }
        
        // Filtrar datos según criterios seleccionados
        function filterData() {
            const dateRange = document.getElementById('date-range').value;
            const statusFilter = document.getElementById('status-filter').value;
            const divisionFilter = document.getElementById('division-filter').value;
            const executorFilter = document.getElementById('executor-filter').value;
            const orderTypeFilter = document.getElementById('order-type-filter').value;
            const searchTerm = document.getElementById('search').value.toLowerCase();
            
            // Si es "all", no filtrar por fecha
            if (dateRange === 'all') {
                return ordersData.filter(order => applyOtherFilters(order, statusFilter, divisionFilter, executorFilter, orderTypeFilter, searchTerm));
            }
            
            const days = parseInt(dateRange);
            const now = new Date();
            const startDate = new Date();
            startDate.setDate(now.getDate() - days);
            
            return ordersData.filter(order => {
                // Filtrar por fecha (si existe una fecha de recepción)
                if (order['Fecha Recepción F8']) {
                    try {
                        const orderDate = new Date(order['Fecha Recepción F8']);
                        if (orderDate < startDate) return false;
                    } catch (e) {
                        // Si hay error al parsear la fecha, no filtrar por fecha
                        console.warn('Error al parsear fecha:', order['Fecha Recepción F8']);
                    }
                }
                
                return applyOtherFilters(order, statusFilter, divisionFilter, executorFilter, orderTypeFilter, searchTerm);
            });
        }
        
        // Aplicar otros filtros
        function applyOtherFilters(order, statusFilter, divisionFilter, executorFilter, orderTypeFilter, searchTerm) {
            // Filtrar por estado
            if (statusFilter !== 'all') {
                if (order.Estado !== statusFilter) return false;
            }
            
            // Filtrar por división
            if (divisionFilter !== 'all') {
                if (order.División !== divisionFilter) return false;
            }
            
            // Filtrar por unidad ejecutora
            if (executorFilter !== 'all') {
                if (order['Unidad Ejecutora'] !== executorFilter) return false;
            }
            
            // Filtrar por tipo de pedido
            if (orderTypeFilter !== 'all') {
                if (order['Tipo de Pedido'] !== orderTypeFilter) return false;
            }
            
            // Filtrar por término de búsqueda
            if (searchTerm) {
                const searchableText = Object.values(order).join(' ').toLowerCase();
                if (!searchableText.includes(searchTerm)) return false;
            }
            
            return true;
        }
        
        // Determinar el estado de un pedido (si no está definido en los datos)
        function determineStatus(order) {
            // Si ya tiene un estado definido, usarlo
            if (order.Estado) return order.Estado;
            
            // Lógica para determinar el estado basado en fechas
            const today = new Date();
            const receptionDate = order['Fecha Recepción F8'] ? new Date(order['Fecha Recepción F8']) : null;
            const deliveryDate = order['Fecha Entrega Real'] ? new Date(order['Fecha Entrega Real']) : null;
            
            if (deliveryDate) {
                return 'Completado';
            } else if (receptionDate) {
                return 'En Proceso';
            } else {
                return 'Pendiente';
            }
        }
        
        // Actualizar métricas principales
        function updateMetrics(data) {
            document.getElementById('total-orders').textContent = data.length;
            
            // Calcular crecimiento (simulado para demostración)
            const growthRate = data.length > 10 ? 12 : 5;
            document.getElementById('growth-rate').textContent = growthRate;
            
            // Contar pedidos por estado
            const statusCounts = {
                'Pendiente': 0,
                'En Proceso': 0,
                'Completado': 0,
                'Retrasado': 0
            };
            
            data.forEach(order => {
                const status = order.Estado || determineStatus(order);
                statusCounts[status] = (statusCounts[status] || 0) + 1;
            });
            
            const pendingCount = statusCounts['Pendiente'] + statusCounts['En Proceso'];
            document.getElementById('pending-orders').textContent = pendingCount;
            
            // Actualizar barras de progreso
            const pendingProgress = data.length > 0 ? 
                (pendingCount / data.length) * 100 : 0;
            document.getElementById('pending-progress').style.width = `${pendingProgress}%`;
            
            // Calcular cantidad total asignada
            const totalAssigned = data.reduce((sum, order) => {
                const quantity = order['Cantidad Total Asignada'];
                return sum + (quantity ? Number(quantity) : 0);
            }, 0);
            document.getElementById('total-assigned').textContent = totalAssigned.toLocaleString();
            
            // Calcular tasa de completitud
            const completionRate = data.length > 0 ? 
                Math.round((statusCounts['Completado'] / data.length) * 100) : 0;
            document.getElementById('completion-rate').textContent = `${completionRate}%`;
            document.getElementById('completion-progress').style.width = `${completionRate}%`;
        }
        
        // Actualizar gráficos
        function updateCharts(data) {
            updateOrdersChart(data);
            updateStatusChart(data);
        }
        
        // Actualizar gráfico de evolución de pedidos
        function updateOrdersChart(data) {
            const ctx = document.getElementById('orders-chart').getContext('2d');
            
            // Destruir gráfico existente si existe
            if (ordersChart) {
                ordersChart.destroy();
            }
            
            // Agrupar datos por fecha (simulados para demostración)
            const last7Days = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                last7Days.push(date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' }));
            }
            
            // Datos simulados (en una implementación real, se calcularían de los datos)
            const received = [12, 15, 8, 10, 14, 11, 13];
            const completed = [8, 10, 6, 9, 12, 8, 10];
            
            ordersChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: last7Days,
                    datasets: [
                        {
                            label: 'Pedidos Recibidos',
                            data: received,
                            backgroundColor: 'rgba(52, 152, 219, 0.7)',
                            borderColor: '#3498db',
                            borderWidth: 1
                        },
                        {
                            label: 'Pedidos Completados',
                            data: completed,
                            backgroundColor: 'rgba(46, 204, 113, 0.7)',
                            borderColor: '#2ecc71',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Evolución de Pedidos por Día'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Número de Pedidos'
                            }
                        }
                    }
                }
            });
        }
        
        // Actualizar gráfico de estado de pedidos
        function updateStatusChart(data) {
            const ctx = document.getElementById('status-chart').getContext('2d');
            
            // Destruir gráfico existente si existe
            if (statusChart) {
                statusChart.destroy();
            }
            
            // Contar pedidos por estado
            const statusCounts = {
                'Pendiente': 0,
                'En Proceso': 0,
                'Completado': 0,
                'Retrasado': 0
            };
            
            data.forEach(order => {
                const status = order.Estado || determineStatus(order);
                statusCounts[status] = (statusCounts[status] || 0) + 1;
            });
            
            statusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Pendiente', 'En Proceso', 'Completado', 'Retrasado'],
                    datasets: [{
                        data: [
                            statusCounts['Pendiente'],
                            statusCounts['En Proceso'],
                            statusCounts['Completado'],
                            statusCounts['Retrasado']
                        ],
                        backgroundColor: [
                            '#ffc107',
                            '#17a2b8',
                            '#28a745',
                            '#dc3545'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        }
                    }
                }
            });
        }
        
        // Actualizar tabla de pedidos
        function updateTable(data) {
            const tableBody = document.getElementById('orders-table-body');
            tableBody.innerHTML = '';
            
            if (data.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="22" class="text-center">No se encontraron pedidos con los filtros aplicados</td>
                    </tr>
                `;
                return;
            }
            
            data.forEach(order => {
                const status = order.Estado || determineStatus(order);
                const statusClass = 
                    status === 'Completado' ? 'status-completed' : 
                    status === 'Pendiente' ? 'status-pending' : 
                    status === 'En Proceso' ? 'status-in-process' : 'status-delayed';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${order.ID || order['ID Pedido'] || 'N/A'}</td>
                    <td>${order['Expedido a CSW'] || 'N/A'}</td>
                    <td>${order['Unidad Ejecutora'] || 'N/A'}</td>
                    <td>${order['Tipo de Pedido'] || 'N/A'}</td>
                    <td>${order.División || 'N/A'}</td>
                    <td>${order.Grupo || 'N/A'}</td>
                    <td>${order['Tipo Sustancias'] || 'N/A'}</td>
                    <td>${order['Cantidad Total Asignada'] || '0'}</td>
                    <td>${order['Cantidad Total Solicitada'] || '0'}</td>
                    <td>${order['Rm. Asignados'] || '0'}</td>
                    <td>${formatDate(order['Fecha Recepción F8'])}</td>
                    <td>${formatDate(order['Fecha Salida'])}</td>
                    <td>${formatDate(order['Fecha Disponición'])}</td>
                    <td>${formatDate(order['Fecha Facturación'])}</td>
                    <td>${formatDate(order['Fecha Empacado'])}</td>
                    <td>${formatDate(order['Fecha Entrega Real'])}</td>
                    <td>${order['Tiempo Estable'] || 'N/A'}</td>
                    <td>${order['% Procesamiento'] || '0'}%</td>
                    <td>${order['Coeficiente Anexo: U1'] || 'N/A'}</td>
                    <td>${order['Coeficiente V/L'] || 'N/A'}</td>
                    <td><span class="status-badge ${statusClass}">${status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary action-btn" title="Ver detalles">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success action-btn" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // Formatear fecha para mostrar
        function formatDate(dateString) {
            if (!dateString || dateString === 'N/A' || dateString === '') return 'N/A';
            
            try {
                // Intentar diferentes formatos de fecha
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return dateString;
                
                return date.toLocaleDateString('es-ES');
            } catch (e) {
                return dateString;
            }
        }
        
        // Mostrar estado de carga
        function showLoadingState() {
            const tableBody = document.getElementById('orders-table-body');
            tableBody.innerHTML = `
                <tr>
                    <td colspan="22" class="text-center">
                        <div class="loading-spinner">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando datos...</span>
                            </div>
                            <span class="ms-2">Cargando datos desde Google Sheets...</span>
                        </div>
                    </td>
                </tr>
            `;
            
            // Resetear métricas
            document.getElementById('total-orders').textContent = '--';
            document.getElementById('pending-orders').textContent = '--';
            document.getElementById('total-assigned').textContent = '--';
            document.getElementById('completion-rate').textContent = '--';
            document.getElementById('growth-rate').textContent = '--';
        }
        
        // Mostrar estado de error
        function showErrorState(message) {
            const tableBody = document.getElementById('orders-table-body');
            tableBody.innerHTML = `
                <tr>
                    <td colspan="22" class="text-center text-danger">
                        <i class="fas fa-exclamation-triangle"></i> ${message}
                    </td>
                </tr>
            `;
        }
        
        // Actualizar hora de última actualización
        function updateLastUpdateTime() {
            const now = new Date();
            const formattedTime = now.toLocaleTimeString('es-ES', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
            const formattedDate = now.toLocaleDateString('es-ES');
            document.getElementById('last-update').textContent = 
                `Última actualización: ${formattedDate} ${formattedTime}`;
        }
        
        // Función para actualizar información de depuración
        function updateDataInfo(message) {
            document.getElementById('data-info').textContent = message;
        }
    </script>
</body>
</html>